{% extends "index.html" %}

{% block title %}Modificar Visita{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/nueva_visita.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/empresas.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modificar_visita.css') }}">
{% endblock %}

{% block header %}
<div class="header-custom text-white px-4 py-3 d-flex flex-column align-items-center">
    <h1 class="h3 mb-1 font-weight-bold">
        Modificar Visita Tur√≠stica
    </h1>
    <span class="lead font-weight-semibold">
        Editando visita de: {{ visita.nombre_institucion }}
    </span>
</div>
{% endblock %}

{% block content %}
    <div class="container">
        <!-- Informaci√≥n del proceso -->
        <div class="section">
            <div class="info-panel">
                <div class="info-item">
                    <strong>üìù Modificando:</strong> 
                    Est√° editando la visita de <strong>{{ visita.nombre_institucion }}</strong>. Los cambios se guardar√°n al presionar "Actualizar Visita".
                </div>
                <div class="info-item">
                    <strong>üìÖ Estado actual:</strong> 
                    Esta visita est√° en estado <strong>{{ visita.estado }}</strong> y programada para el {{ visita.fecha_visita }}.
                </div>
            </div>
        </div>

        <form action="/modificar_visita/{{ visita.id }}" method="POST" class="form-solicitud">
            <!-- A. DATOS DE LA INSTITUCI√ìN -->
            <div class="section">
                <h2>A. Datos de la Instituci√≥n</h2>
                <div class="form-group">
                    <label for="nombre_institucion">Nombre de la Instituci√≥n:</label>
                    <input type="text" id="nombre_institucion" name="nombre_institucion" value="{{ visita.nombre_institucion }}" required>
                </div>
                <div class="form-group">
                    <label for="localidad">Localidad:</label>
                    <input type="text" id="localidad" name="localidad" value="{{ visita.localidad if visita.localidad else '' }}" required>
                </div>
                <div class="form-group">
                    <label for="director">Director/a:</label>
                    <input type="text" id="director" name="director" value="{{ visita.responsable }}" required>
                </div>
                <div class="form-group">
                    <label for="correo_institucional">Correo Electr√≥nico Institucional:</label>
                    <input type="email" id="correo_institucional" name="correo_institucional" value="{{ visita.email }}" required>
                </div>
                <div class="form-group">
                    <label for="telefono_institucion">Tel√©fono de la Instituci√≥n:</label>
                    <input type="tel" id="telefono_institucion" name="telefono_institucion" value="{{ visita.telefono }}" required>
                </div>
            </div>

            <!-- B. DATOS DEL CONTINGENTE -->
            <div class="section">
                <h2>B. Datos del Contingente</h2>
                <div class="form-group">
                    <label for="contacto_principal">Nombre del Contacto Principal:</label>
                    <input type="text" id="contacto_principal" name="contacto_principal" value="{{ visita.contacto_principal }}" required>
                </div>
                <div class="form-group">
                    <label for="telefono_contacto_principal">Tel√©fono del Contacto Principal:</label>
                    <input type="tel" id="telefono_contacto_principal" name="telefono_contacto_principal" value="{{ visita.telefono_contacto_principal }}" required>
                </div>
                <div class="form-group">
                    <label for="relacion_contacto">Relaci√≥n del Contacto con el Grupo:</label>
                    <input type="text" id="relacion_contacto" name="relacion_contacto" value="{{ visita.relacion_contacto }}" required>
                </div>
                <div class="form-group">
                    <label for="contacto_suplente">Nombre del Contacto Suplente:</label>
                    <input type="text" id="contacto_suplente" name="contacto_suplente" value="{{ visita.contacto_suplente }}">
                </div>
                <div class="form-group">
                    <label for="telefono_contacto_suplente">Tel√©fono del Contacto Suplente:</label>
                    <input type="tel" id="telefono_contacto_suplente" name="telefono_contacto_suplente" value="{{ visita.telefono_contacto_suplente }}">
                </div>
                <div class="form-group">
                    <label for="nivel_educativo">Nivel Educativo:</label>
                    <select id="nivel_educativo" name="nivel_educativo" required>
                        <option value="">Seleccione el nivel</option>
                        <option value="Primario" {% if visita.nivel_educativo == 'Primario' %}selected{% endif %}>Escuela Primaria</option>
                        <option value="Secundario" {% if visita.nivel_educativo == 'Secundario' %}selected{% endif %}>Escuela Secundaria</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cantidad_alumnos">Cantidad de Alumnos:</label>
                    <input type="number" id="cantidad_alumnos" name="cantidad_alumnos" value="{{ visita.cantidad_alumnos }}" required>
                </div>
                <div class="form-group">
                    <label for="edad_alumnos">Edad o Rango Etario:</label>
                    <input type="text" id="edad_alumnos" name="edad_alumnos" value="{{ visita.edad_alumnos }}" required>
                </div>
                <div class="form-group">
                    <label>¬øHay alumnos/as con discapacidad?</label>
                    <div>
                        <input type="radio" id="discapacidad_si" name="discapacidad" value="S√≠" 
                               {{ 'checked' if visita.discapacidad == 'S√≠' }} required>
                        <label for="discapacidad_si">S√≠</label>
                        <input type="radio" id="discapacidad_no" name="discapacidad" value="No" 
                               {{ 'checked' if visita.discapacidad == 'No' }} required>
                        <label for="discapacidad_no">No</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="tipo_discapacidad">Tipo de discapacidad (si aplica):</label>
                    <input type="text" id="tipo_discapacidad" name="tipo_discapacidad" 
                           value="{{ visita.tipo_discapacidad if visita.tipo_discapacidad else '' }}">
                </div>
                <div class="form-group">
                    <label>¬øRequiere adaptaci√≥n?</label>
                    <div>
                        <input type="radio" id="adaptacion_si" name="adaptacion" value="S√≠"
                               {{ 'checked' if visita.adaptacion == 'S√≠' }}>
                        <label for="adaptacion_si">S√≠</label>
                        <input type="radio" id="adaptacion_no" name="adaptacion" value="No"
                               {{ 'checked' if visita.adaptacion == 'No' }}>
                        <label for="adaptacion_no">No</label>
                    </div>
                </div>
            </div>

            <!-- C. SELECCI√ìN DE EMPRESAS A VISITAR -->
            <div class="section">
                <h2>C. Selecci√≥n de Empresas a Visitar</h2>
                <div id="empresas-section">
                    <p>üìù Seleccione las empresas a visitar:</p>
                    <div class="lugares-container" id="empresas-container">
                        {% for empresa in empresas %}
                        <div class="lugar-item" 
                             data-tipo-institucion="{{ empresa.tipo_institucion }}" 
                             data-nivel-educativo="{{ empresa.nivel_educativo }}">
                            <input type="checkbox" 
                                   id="empresa_{{ empresa.id }}" 
                                   name="empresas_seleccionadas" 
                                   value="{{ empresa.id }}"
                                   {% if empresa.id|string in visita.lugares %}checked{% endif %}>
                            <label for="empresa_{{ empresa.id }}" class="lugar-label">
                                <div class="lugar-info">
                                    <h4>üè¢ {{ empresa.nombre }}</h4>
                                    <p class="categoria">üìÇ {{ empresa.categoria }}</p>
                                    <p class="contacto">üìß {{ empresa.email }}</p>
                                    <p class="contacto">üìû {{ empresa.telefono }}</p>
                                </div>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% if not empresas %}
                    <div class="info-panel warning">
                        <p>‚ö†Ô∏è No hay empresas registradas en el sistema</p>
                        <p>Primero debe <a href="/gestionar_empresas" target="_blank">registrar algunas empresas</a> para poder modificar la visita.</p>
                    </div>
                {% endif %}
                <div class="form-group">
                    <label for="observaciones_empresas">Observaciones sobre las empresas elegidas:</label>
                    <textarea id="observaciones_empresas" name="observaciones_empresas" rows="3" placeholder="Por ejemplo: Inter√©s particular en el √°rea de producci√≥n, preferencias de horarios, etc.">{{ visita.observaciones }}</textarea>
                </div>
            </div>

            <!-- D. FECHA Y HORARIO PROPUESTO -->
            <div class="section">
                <h2>D. Fecha y Horario Propuesto</h2>
                <div class="form-group">
                    <label for="fecha_visita">Fecha de la Visita:</label>
                    <input type="date" id="fecha_visita" name="fecha_visita" value="{{ visita.fecha_visita }}" required>
                </div>
                <div class="form-group">
                    <label for="hora_grupo1">Hora Propuesta para el Grupo 1:</label>
                    <input type="time" id="hora_grupo1" name="hora_grupo1" value="{{ visita.hora_grupo1.strftime('%H:%M') if visita.hora_grupo1 else '' }}">
                </div>
                <div class="form-group">
                    <label for="hora_grupo2">Hora Propuesta para el Grupo 2:</label>
                    <input type="time" id="hora_grupo2" name="hora_grupo2" value="{{ visita.hora_grupo2.strftime('%H:%M') if visita.hora_grupo2 else '' }}">
                </div>
                <div class="form-group">
                    <label for="observaciones">Observaciones:</label>
                    <textarea id="observaciones" name="observaciones">{{ visita.observaciones }}</textarea>
                </div>
            </div>

            <!-- Botones -->
            <div class="botones">
                <button type="submit" class="boton-enviar">
                    üíæ Actualizar Visita
                </button>
                <a href="{{ url_for('consultar_visitas') }}" class="boton-volver">
                    ‚Ü©Ô∏è Volver a Consultas
                </a>
            </div>
        </form>

        <!-- Estado actual de la visita -->
        <div class="section">
            <h2>üìä Estado Actual</h2>
            <div class="estado-empresa">
                <div class="estado-item">
                    <span class="estado-badge {{ 'activa' if visita.estado == 'Confirmada' else 'pendiente' if visita.estado == 'Pendiente' else 'inactiva' }}">
                        {% if visita.estado == 'Confirmada' %}
                        ‚úÖ Visita Confirmada
                        {% elif visita.estado == 'Pendiente' %}
                        ‚è≥ Visita Pendiente
                        {% else %}
                        ‚ùå Visita Rechazada
                        {% endif %}
                    </span>
                </div>
                <div class="estado-item">
                    <span class="nivel-badge">üìÖ {{ visita.fecha_visita }}</span>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n adicional -->
        <div class="section">
            <h2>‚ÑπÔ∏è Gu√≠a de Modificaci√≥n</h2>
            <div class="info-panel">
                <div class="info-item">
                    <strong>üîÑ Cambios:</strong> 
                    Cualquier modificaci√≥n que realice se aplicar√° inmediatamente al registro de la visita.
                </div>
                <div class="info-item">
                    <strong>üìÖ Fechas:</strong> 
                    Si cambia la fecha, aseg√∫rese de coordinar con las empresas y la instituci√≥n visitante.
                </div>
                <div class="info-item">
                    <strong>üìö Niveles:</strong> 
                    Recuerde que el sistema maneja √∫nicamente Primario y Secundario seg√∫n las especificaciones de la Direcci√≥n de Turismo.
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/validaciones.js') }}"></script>
<script src="{{ url_for('static', filename='js/filtro_empresas_modificar.js') }}"></script>
{% endblock %}